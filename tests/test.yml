---

- hosts: agent
  remote_user: root
  become: True
  tasks:
    - name: Install repo for Java 8 in Ubuntu 14.04
      apt_repository: repo='ppa:openjdk-r/ppa'
      when: "ansible_distribution_release == 'trusty'"

- hosts: agent
  remote_user: root
  become: True
  roles:
    - role: geerlingguy.java
      when: "ansible_os_family == 'Debian'"
      java_packages:
        - openjdk-8-jdk
    - role: geerlingguy.java
      when: "ansible_os_family == 'RedHat'"
      java_packages:
        - java-1.8.0-openjdk
    - role: abelboldu.midonet-repos
      midonet_version: current
    - role: abelboldu.zookeeper
      zookeeper_hosts: '{{ groups["agent"] }}'
    - role: ansible-midonet-agent
      zookeeper_hosts: '{{ groups["agent"] }}'
      cluster_password: 'midonet'
      max_heap_size: "512M"
  post_tasks:
    - name: Check java process is running
      shell: ps auxf | grep java
      register: command_result_java
      failed_when: "'java' not in command_result_java.stdout"

    - name: Check midolman process is running
      shell: ps auxf | grep midolman
      register: command_result_midolman
      failed_when: "'midolman' not in command_result_midolman.stdout"
